/*! caja-kissy 2013-08-27 */
KISSY.add("init-countdown-widgets",function(t){function n(n,e){var o=this;cfg={timeBegin:0,collateurl:"",collateval:0},o.timeStart=new Date,o.config=t.merge(cfg,e||{}),o._countTime(n)}function e(n,o,a){var r={d:".ks-d",h:".ks-h",m:".ks-m",s:".ks-s",i:".ks-i"},i={interval:1e3,timeUnitCls:r,minDigit:2,timeRunCls:".ks-countdown-run",timeEndCls:".ks-countdown-end"},c=t.merge(i,a);c.run&&!t.isFunction(c.run)&&delete c.run,c.end&&!t.isFunction(c.end)&&delete c.end,c.interval=parseInt(c.interval),(isNaN(c.interval)||200>c.interval)&&(c.interval=200),e.superclass.constructor.call(this,o,c),this.counter(n)}function o(n,e){var o=function(n){t.isDate(n)||(n=new Date),t.isFunction(e)&&e(n)};t.io({url:n,type:"HEAD",success:function(t,n,e){o(new Date(e.getResponseHeader("date")))},error:function(){o(new Date)},cache:!1})}function o(n,e){function o(t,n){1e3>t?e(n):3>r?a():e(new Date(n.setMilliseconds(n.getMilliseconds()+t/2)))}function a(){var e=new Date;r++,t.io({url:n,type:"HEAD",success:function(t,n,a){o(new Date-e,new Date(a.getResponseHeader("date")))},error:function(){o()},cache:!1})}var r=0;a()}function a(n,e,a){n="."+(n||"J_TWidget");var i=function(o){t.query(n,e).each(function(n){var e=r.attr(n,"data-widget-type"),a=r.attr(n,"data-widget-config");"Countdown"===e&&(a=t.isNull(a)?{}:JSON.parse(a.replace(/'/g,'"')),o&&t.isDate(o)&&(a.timeBegin=o),new t.Countdown(n,a.endTime,a))})};a?o(a,i):i()}var r=t.DOM,i={d:864e5,h:36e5,m:6e4,s:1e3,i:1},c=["d","h","m","s","i"];return n.prototype={_countTime:function(n){var e=this,o=e.config,a=o.timeBegin,r=0;if(/^(\d{4})\-(\d{1,2})\-(\d{1,2})(\s+)(\d{1,2}):(\d{1,2}):(\d{1,2})$/gi.test(n.replace(/\./g,"-"))){var i=n.match(/\d+/g);n=new Date(i[0],i[1]-1,i[2],i[3],i[4],i[5])}else/^\d+&/.test(n)&&(n=parseInt(n));r=t.isNull(a)||isNaN(a)||0>=a?t.isDate(n)?n-new Date:parseInt(n):typeof a==typeof n?n-a:0,(!t.isNumber(r)||0>r)&&(r=0),e.timeRemain=r},getRemain:function(){var t=parseInt(this.timeRemain-(new Date-this.timeStart));return isNaN(t)||0>=t?0:t},format:function(n){var e=Array.prototype.slice.call(arguments,1),o=[];return t.each(e,function(t){if(i[t]){var e=Math.floor(n/i[t]);n-=e*i[t],o.push(e)}}),o},fetch:function(t,n,e){var o=this,a=setInterval(function(){var t=o.getRemain();t>0?n&&n.call(o,t):(n&&n.call(o,0),e&&e.call(o),clearInterval(a))},t)}},t.extend(e,n,{counter:function(n){var e=this,o=e.config,a=function(n){var a=[n].concat(l),r=e.format.apply(this,a);t.each(d,function(t,n){t.text(r[n])}),o.run&&o.run.call(e,a,r)},r=function(){u.hide(),s.show(),o.end&&o.end.call(e)},i=o.timeUnitCls,n=t.one(n),u=n.all(o.timeRunCls),s=n.all(o.timeEndCls),d=[],l=[];t.each(c,function(t){i[t]&&n.one(i[t])&&(d.push(n.one(i[t])),l.push(t))}),u.show(),s.hide(),e.fetch(o.interval,a,r)}}),e.autoRender=a,e.Core=n,e.getServerTime=o,t.Countdown=e,e}),KISSY.use("switchable, init-countdown-widgets",function(t,n,e){function o(o,a){function r(){t.later(function(){if(0!==u.length){try{i(u.shift())}catch(n){t.log("��ʼ����������")}r()}},0)}function i(o){var a,r=o.getAttribute("data-widget-type");if(r)try{switch(a=o.getAttribute("data-widget-config"),a&&(a=a.replace(/'/g,'"')),a=t.JSON.parse(a),!0){case c.switchable.indexOf(r)>-1:new n(o,a);break;case c.countdown.indexOf(r)>-1:new e(o,a.endTime,a);break;default:t.log("��kissy����û�в��ҵ�����Ҫ��ʼ��������")}}catch(i){t.log("widget "+i,"warn")}}o="."+(o||"KS_Widget");var c={switchable:"Tabs Slide Carousel Accordion",overlay:"Popup",countdown:"Countdown"},u=t.query(o,a);r()}var a=t.DOM,r="J_TScriptedModule";KISSY.each(a.query("."+r),function(t){o("J_TWidget",t)})});